<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Xoldyx Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Inter, system-ui, Arial;
            background: #0F172A;
            color: #F1F5F9;
        }
        .glass {
            background: rgba(148, 163, 184, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(12px);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Verificación de Administrador -->
    <script>
        function checkAdminAccess() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (!currentUser.email || (currentUser.email !== 'oroscoyerson2019@gmail.com' && !currentUser.isAdmin)) {
                alert('No tienes permisos de administrador');
                window.location.href = '../index.html';
                return false;
            }
            return true;
        }

        // Verificar acceso al cargar la página
        // Función para actualizar estadísticas
        function updateStats() {
            // Actualizar contador de visitas
            const visits = parseInt(localStorage.getItem('visitorCount')) || 0;
            document.getElementById('visitorCount').textContent = visits.toLocaleString();

            // Actualizar contador de usuarios
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            document.getElementById('userCount').textContent = users.length.toLocaleString();

            // Actualizar contador de administradores
            const admins = users.filter(user => {
                const isMainAdmin = CryptoJS.AES.decrypt(user.email, 'XoldyxSecretKey2025').toString(CryptoJS.enc.Utf8) === 'oroscoyerson2019@gmail.com';
                return isMainAdmin || user.isAdmin;
            }).length;
            document.getElementById('adminCount').textContent = admins.toLocaleString();
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!checkAdminAccess()) return;
            document.getElementById('adminPanel').classList.remove('hidden');
            
            // Actualizar estadísticas cada 30 segundos
            updateStats();
            setInterval(updateStats, 30000);
        });
    </script>

    <!-- Panel Principal -->
    <div id="adminPanel" class="hidden">
        <header class="bg-slate-800/50 border-b border-white/10">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold text-emerald-400">Panel de Administración</h1>
                <div class="flex gap-4">
                    <button onclick="location.href='../index.html'" class="px-4 py-2 rounded bg-slate-700/50">
                        Ir a la tienda
                    </button>
                    <button onclick="logout()" class="px-4 py-2 rounded bg-red-500/50">
                        Cerrar Sesión
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <!-- Panel de Estadísticas -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Contador de Visitas -->
                <div class="glass p-6">
                    <h3 class="text-lg font-semibold mb-2 text-emerald-400">Visitas Totales</h3>
                    <div class="flex items-center justify-between">
                        <div class="text-4xl font-bold" id="visitorCount">0</div>
                        <div class="text-emerald-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Usuarios Registrados -->
                <div class="glass p-6">
                    <h3 class="text-lg font-semibold mb-2 text-emerald-400">Usuarios Registrados</h3>
                    <div class="flex items-center justify-between">
                        <div class="text-4xl font-bold" id="userCount">0</div>
                        <div class="text-emerald-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Administradores -->
                <div class="glass p-6">
                    <h3 class="text-lg font-semibold mb-2 text-emerald-400">Administradores</h3>
                    <div class="flex items-center justify-between">
                        <div class="text-4xl font-bold" id="adminCount">0</div>
                        <div class="text-emerald-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Gestión de Cupones -->
                <div class="glass p-6">
                    <h2 class="text-xl font-semibold mb-4 text-emerald-400">Gestión de Cupones</h2>
                    <form id="cuponForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Código del Cupón</label>
                            <input type="text" id="cuponCode" class="w-full p-2 rounded bg-slate-800 border border-emerald-600/20" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Descuento (%)</label>
                            <input type="number" id="cuponDiscount" min="1" max="100" class="w-full p-2 rounded bg-slate-800 border border-emerald-600/20" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Fecha de Expiración</label>
                            <input type="date" id="cuponExpiry" class="w-full p-2 rounded bg-slate-800 border border-emerald-600/20" required>
                        </div>
                        <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-2 px-4 rounded transition duration-300">
                            Crear Cupón
                        </button>
                    </form>
                    <div class="mt-6">
                        <h3 class="text-lg font-medium mb-2">Cupones Activos</h3>
                        <div id="cuponesList" class="space-y-2">
                            <!-- Los cupones se mostrarán aquí -->
                        </div>
                    </div>
                </div>

                <!-- Gestión de Administradores -->
                <div class="glass p-6">
                    <h2 class="text-xl font-semibold mb-4 text-emerald-400">Gestión de Administradores</h2>
                    <form id="inviteAdminForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Invitar Nuevo Administrador</label>
                            <div class="flex gap-2">
                                <input type="email" id="inviteEmail" placeholder="Correo electrónico" 
                                       class="flex-1 p-2 rounded bg-slate-800 border border-emerald-600/20" required>
                                <button type="submit" 
                                        class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded transition duration-300">
                                    Invitar
                                </button>
                            </div>
                        </div>
                    </form>
                    <div class="mt-6">
                        <h3 class="text-lg font-medium mb-2">Administradores Actuales</h3>
                        <div id="adminList" class="space-y-2">
                            <!-- Lista de administradores -->
                        </div>
                    </div>
                </div>

                <!-- Buzón de Notificaciones -->
                <div class="glass p-6">
                    <h2 class="text-xl font-semibold mb-4 text-emerald-400">Buzón de Notificaciones</h2>
                    <div id="notificationList" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Las notificaciones se mostrarán aquí -->
                    </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Tipo</label>
                            <select id="notificationType" class="w-full p-2 rounded bg-slate-800 border border-emerald-600/20">
                                <option value="info">Información</option>
                                <option value="success">Éxito</option>
                                <option value="warning">Advertencia</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-2 px-4 rounded transition duration-300">
                            Publicar Notificación
                        </button>
                    </form>
                    <div class="mt-6">
                        <h3 class="text-lg font-medium mb-2">Notificaciones Activas</h3>
                        <div id="notificationsList" class="space-y-2">
                            <!-- Las notificaciones se mostrarán aquí -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estadísticas -->
            <div class="glass p-6 mt-8">
                <h2 class="text-xl font-semibold mb-4 text-emerald-400">Estadísticas</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 bg-slate-800/50 rounded">
                        <h3 class="text-sm font-medium mb-1">Cupones Activos</h3>
                        <p id="cuponesCount" class="text-2xl font-bold text-emerald-400">0</p>
                    </div>
                    <div class="p-4 bg-slate-800/50 rounded">
                        <h3 class="text-sm font-medium mb-1">Notificaciones Activas</h3>
                        <p id="notificationsCount" class="text-2xl font-bold text-emerald-400">0</p>
                    </div>
                    <div class="p-4 bg-slate-800/50 rounded">
                        <h3 class="text-sm font-medium mb-1">Última Actividad</h3>
                        <p id="lastActivity" class="text-sm text-slate-400">-</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Configuración de encriptación y credenciales predeterminadas
        const ADMIN_CREDENTIALS = {
            username: 'devyer',
            password: 'patito123'
        };

        // Verificar credenciales sin encriptación para el admin principal
        function checkMainAdmin(username, password) {
            return username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password;
        }

        // Elementos del DOM
        const loginModal = document.getElementById('loginModal');
        const adminPanel = document.getElementById('adminPanel');
        const loginForm = document.getElementById('loginForm');
        const cuponForm = document.getElementById('cuponForm');
        const notificationForm = document.getElementById('notificationForm');

        // Verificar autenticación al cargar
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            loginModal.style.display = isLoggedIn ? 'none' : 'flex';
            adminPanel.style.display = isLoggedIn ? 'block' : 'none';
            if (isLoggedIn) {
                updateStats();
                updateCuponesList();
                updateNotificationsList();
            }
        }

        // Login
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
        // Función para gestionar notificaciones
        function createNotification(type, title, message, userId) {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            notifications.push({
                id: Date.now(),
                type,
                title,
                message,
                userId,
                read: false,
                date: new Date().toISOString()
            });
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationList();
        }

        // Función para marcar notificaciones como leídas
        function markNotificationRead(id) {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                localStorage.setItem('notifications', JSON.stringify(notifications));
                updateNotificationList();
            }
        }

        // Invitar administrador
        document.getElementById('inviteAdminForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('inviteEmail').value;
            
            // Verificar si el usuario existe
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.email === email);
            
            if (!user) {
                alert('El usuario debe estar registrado primero');
                return;
            }

            if (user.isAdmin) {
                alert('Este usuario ya es administrador');
                return;
            }

            if (email === 'oroscoyerson2019@gmail.com') {
                alert('Este usuario ya es super administrador');
                return;
            }

            // Enviar invitación
            createNotification(
                'admin_invite',
                'Invitación para ser administrador',
                `Has sido invitado por ${JSON.parse(localStorage.getItem('currentUser')).email} para ser administrador de Xoldyx Store`,
                email
            );

            alert('Invitación enviada correctamente');
            this.reset();
            updateAdminList();
        });

        // Logout
        function logout() {
            localStorage.removeItem('adminLoggedIn');
            logActivity('Cierre de sesión');
            location.reload();
        }

        // Gestión de Cupones
        cuponForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const cupon = {
                code: document.getElementById('cuponCode').value.toUpperCase(),
                discount: document.getElementById('cuponDiscount').value,
                expiry: document.getElementById('cuponExpiry').value,
                createdAt: new Date().toISOString()
            };
            
            const cupones = JSON.parse(localStorage.getItem('cupones') || '[]');
            cupones.push(cupon);
            localStorage.setItem('cupones', JSON.stringify(cupones));
            
            updateCuponesList();
            updateStats();
            logActivity(`Cupón creado: ${cupon.code}`);
            this.reset();
        });

        function updateCuponesList() {
            const cupones = JSON.parse(localStorage.getItem('cupones') || '[]');
            const cuponesList = document.getElementById('cuponesList');
            cuponesList.innerHTML = cupones.map((cupon, index) => `
                <div class="flex justify-between items-center p-2 bg-slate-800/50 rounded">
                    <div>
                        <span class="font-medium">${cupon.code}</span>
                        <span class="text-sm text-slate-400"> - ${cupon.discount}% hasta ${new Date(cupon.expiry).toLocaleDateString()}</span>
                    </div>
                    <button onclick="deleteCupon(${index})" class="text-red-400 hover:text-red-500">Eliminar</button>
                </div>
            `).join('');
        }

        function deleteCupon(index) {
            const cupones = JSON.parse(localStorage.getItem('cupones') || '[]');
            const deleted = cupones.splice(index, 1)[0];
            localStorage.setItem('cupones', JSON.stringify(cupones));
            updateCuponesList();
            updateStats();
            logActivity(`Cupón eliminado: ${deleted.code}`);
        }

        // Actualizar lista de administradores
        function updateAdminList() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const adminList = document.getElementById('adminList');
            
            const admins = users.filter(user => user.isAdmin || user.email === 'oroscoyerson2019@gmail.com');
            
            adminList.innerHTML = admins.map(admin => `
                <div class="flex justify-between items-center p-3 rounded bg-slate-800/50">
                    <div>
                        <span class="font-medium">${admin.email}</span>
                        ${admin.email === 'oroscoyerson2019@gmail.com' ? 
                            '<span class="ml-2 text-xs bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded">Super Admin</span>' : 
                            '<span class="ml-2 text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">Admin</span>'}
                    </div>
                    ${admin.email !== 'oroscoyerson2019@gmail.com' ? `
                        <button onclick="removeAdmin('${admin.email}')" 
                                class="text-red-400 hover:text-red-300 text-sm px-3 py-1 rounded bg-red-500/10 hover:bg-red-500/20">
                            Remover
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        // Actualizar lista de notificaciones
        function updateNotificationList() {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const notificationList = document.getElementById('notificationList');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            notificationList.innerHTML = notifications
                .filter(n => n.type === 'admin_invite' || n.userId === currentUser.email)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(notification => `
                    <div class="p-4 rounded ${notification.read ? 'bg-slate-800/30' : 'bg-slate-800/50 border-l-4 border-emerald-400'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium ${notification.read ? 'text-slate-400' : 'text-emerald-400'}">${notification.title}</h4>
                                <p class="text-sm mt-1 ${notification.read ? 'text-slate-500' : 'text-slate-300'}">${notification.message}</p>
                                <div class="text-xs text-slate-500 mt-2">${new Date(notification.date).toLocaleString()}</div>
                            </div>
                            ${!notification.read ? `
                                <button onclick="markNotificationRead(${notification.id})" 
                                        class="text-sm text-emerald-400 hover:text-emerald-300">
                                    Marcar como leída
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
        }

        // Remover administrador
        function removeAdmin(email) {
            if (!confirm('¿Estás seguro de que quieres remover a este administrador?')) return;
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.email === email);
            
            if (userIndex !== -1) {
                users[userIndex].isAdmin = false;
                localStorage.setItem('users', JSON.stringify(users));
                
                createNotification(
                    'admin_removal',
                    'Removido como administrador',
                    'Has sido removido como administrador de Xoldyx Store',
                    email
                );
                
                updateAdminList();
            }
        }

        function updateNotificationsList() {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = notifications.map((notif, index) => `
                <div class="p-2 bg-slate-800/50 rounded">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium">${notif.title}</h4>
                            <p class="text-sm text-slate-400">${notif.message}</p>
                            <span class="text-xs text-slate-500">${new Date(notif.createdAt).toLocaleString()}</span>
                        </div>
                        <button onclick="deleteNotification(${index})" class="text-red-400 hover:text-red-500">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteNotification(index) {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const deleted = notifications.splice(index, 1)[0];
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationsList();
            updateStats();
            logActivity(`Notificación eliminada: ${deleted.title}`);
        }

        // Estadísticas y actividad
        function updateStats() {
            const cupones = JSON.parse(localStorage.getItem('cupones') || '[]');
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            
            document.getElementById('cuponesCount').textContent = cupones.length;
            document.getElementById('notificationsCount').textContent = notifications.length;
        }

        function logActivity(action) {
            const now = new Date();
            document.getElementById('lastActivity').textContent = `${action} - ${now.toLocaleString()}`;
        }

        // Inicialización
        checkAuth();
    </script>
</body>
</html>
